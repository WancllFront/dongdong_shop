<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        body {background-color: #f4f4f4;}
        .top{width: 100%;background: linear-gradient(to bottom,#3de6ff,#39baff,#358eff);position: relative;}
        .top .setting{width:1rem; top :2rem; position: absolute;left:1rem;}
        .top .comment {top :2rem; position: absolute;right:1rem;display: inline-block;}
        .top .comment div{background-color:#fff;color:#3cd9ff;top:-0.2rem;padding:0px 0px;}
        .top .comment img{width:1.3rem;}
        .top .thum{position: absolute;top:3.5rem;background-color: #fff;border-radius:50%;width:24%;left:38%;overflow: hidden;display: flex;}
        /*.top .thum img{width: 100%;position: absolute;top:50%;left: 50%;transform:translate(-50% , -50%);min-height: 100%;}*/
        .top .thum img{align-items: center;width: 100%;}
        .top .username{text-align: center;bottom: 1rem;;position: absolute;color:#fff;width: 100%;font-size: 0.8rem;}

        .aui-margin-b-15{margin-bottom: 0px !important;}

        .aui-bar-tab{position: relative;padding-top: 0.6rem;padding-bottom: 0.6rem;}
        .aui-bar-tab .aui-bar-tab-item img{width:1.5rem;display:inline-block;}

    </style>
</head>

<body>
    <div class="top" id="top">
        <img class="setting" src="../image/setting.png" tapmode onclick="$api.goWindow('about_me_win')" >
        <div class="comment" tapmode onclick="$api.goWindow('notice_win')" >
            <!-- <div class="aui-badge"></div> -->
            <img  src="../image/comment_white.png">
        </div>
        <div class="thum" id="thum">
            <img src="" id="avatar">
        </div>
        <div class="username" id="username"></div>
    </div>
    <div class="aui-content aui-margin-b-15" style="margin-top:0.3rem;">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-item" tapmode onclick="$api.goWindow('orders_win')">
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">我的订单</div>
                    <div class="aui-list-item-right">
                        <div style="font-size:0.7rem;">查看全部订单</div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div class="aui-bar aui-bar-tab">
        <div class="aui-bar-tab-item" tapmode onclick="$api.goWindow('orders_win',{status:1})">
            <img src="../image/waitingpay.png">
            <div class="aui-bar-tab-label">待付款</div>
        </div>
        <div class="aui-bar-tab-item" tapmode onclick="$api.goWindow('orders_win',{status:2})">
            <img src="../image/fahuo.png">
            <div class="aui-bar-tab-label">待发货</div>
        </div>
        <div class="aui-bar-tab-item" tapmode onclick="$api.goWindow('orders_win',{status:3})">
            <img src="../image/shouhuo.png">
            <div class="aui-bar-tab-label">待收货</div>
        </div>
        <div class="aui-bar-tab-item" tapmode onclick="$api.goWindow('orders_win',{status:4})">
            <img src="../image/pingjia.png">
            <div class="aui-bar-tab-label">待评价</div>
        </div>
        <div class="aui-bar-tab-item">
            <img src="../image/shouhou.png">
            <div class="aui-bar-tab-label">售后服务</div>
        </div>
    </div>

    <div class="aui-content aui-margin-b-15"  style="margin-top:0.6rem;">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-item" tapmode onclick="$api.goWindow('my_wallet_win',{},'none')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/qianbao.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">我的钱包</div>
                    <div class="aui-list-item-right" style="color:#0056c6;font-size:0.7rem;">能生钱的钱包</div>
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('business_cart_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/gouwuche.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    购物车
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('address_win',{shopId:''})">
                <div class="aui-list-item-label-icon">
                    <img src="../image/dizhi.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">我的地址</div>
                    <div class="aui-list-item-right" style="font-size:0.7rem;">管理收货地址</div>
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('collection_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/shoucang.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    我的收藏
                </div>
            </li>
        </ul>
    </div>
    <div class="aui-content aui-margin-b-15" style="margin-top:0.6rem;">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-item" tapmode onclick="$api.goWindow('password_setting_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/mima.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    密码设置
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="authentication()">
                <div class="aui-list-item-label-icon">
                    <img src="../image/shiming.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    实名认证
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('comments_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/pingjia_black.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    我的评价
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('my_qrcode_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/qrcode.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    我的二维码
                </div>
            </li>
            <li class="aui-list-item" tapmode onclick="$api.goWindow('chat_win')">
                <div class="aui-list-item-label-icon">
                    <img src="../image/kefu.png" style="width:1rem;">
                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">我的客服</div>
                    <div class="aui-list-item-right">
                        <div class="aui-dot" style="position:relative;top:0; right:0"></div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div style="height:0.6rem;background-color:#fff;"></div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">
    var uiLoading;
    var userinfo = $api.getStorage('userinfo');

    apiready = function() {
        uiLoading = api.require("UILoading");

        fixPage();
        setRefresh();
        addEventListener()

    };
    setRefresh = function(){
        api.setStatusBarStyle({ style: 'dark' });
        api.setRefreshHeaderInfo({
            bgColor: '#4be4fb',
            textColor: '#fff',
        }, function(ret, err){
            api.refreshHeaderLoadDone();
            api.sendEvent({
                name: 'updateUser',
            });
        });
    }

    fixPage = function(){
        $api.css($api.byId('top'),'height:'+ (api.frameHeight * 0.382) + 'px');
        var thumW = $api.offset($api.byId('thum')).w;
        $api.css($api.byId('thum'),'height:'+ thumW + 'px');
    }

    addEventListener = function(){
        api.addEventListener({
            name: 'updateUser'
        }, function(ret, err){
            userinfo = $api.getStorage('userinfo');
            $api.text($api.byId('username'), userinfo.user.nick_name || userinfo.user.mobile);
            $api.attr($api.byId('avatar'), 'src', userinfo.user.avatar || '../image/avatar.png');
        });

        api.sendEvent({
            name: 'updateUser',
        });
    }

    authentication  = function(){
        $api.ajax('GET',$api.host+'users/'+userinfo.user.id,{},function(ret){
            var authState = ret.data.auth_status
            if(authState == 0){
                getAuthInfo()
            }else if(authState == 1){
                api.toast({
                    msg: '信息审核中',
                    duration: 2000,
                    location: 'bottom'
                });

            }else if(authState == 2){
                api.toast({
                    msg: '恭喜您，您的实名认证审核已经通过!',
                    duration: 2000,
                    location: 'bottom'
                });
            }else if(authState == 3){
                api.alert({
                    title: '提示',
                    msg: '对不起，您没有通过审核，请重新提交审核信息',
                }, function(ret, err){
                    if( ret ){
                        getAuthInfo()
                    }else{
                         alert( JSON.stringify( err ) );
                    }
                });
            }
        },{
            token:userinfo.token.token
        })
    }

    getAuthInfo = function(){
        var faceImgBase64Data = '';
        var idCard = {};
        // detectFace();
        ocridcard();
    }

    ocridcard = function(){
        alert('请将身份证置于相框内')
        getPicture(function(ret){
            uiLoading.flower({
                fixed: true
            }, function(ret){
                uiLoading.id = ret.id;
            });
            $api.apiAjax($api.ocridcardUrl,$api.faceKey,{
                image_file:ret.data
            },function(ret,err){
                uiLoading.closeFlower ({id: uiLoading.id});
                if(ret){
                    if(ret.cards.length == 0){
                        api.alert({
                            title: '提示',
                            msg: '未检测到身份证，请重新拍照',
                        }, function(ret, err){
                            if( ret ){
                                ocridcard()
                            }else{
                                alert( JSON.stringify( err ) );
                            }
                        });
                    }else{
                        submitAuthInfo(ret);
                    }
                }else{
                    alert(err.msg)
                }
            })
        })
    }

    detectFace = function(){
        alert('请将自己置于相框内')
        getPicture(function(ret){
            uiLoading.flower({
                fixed: true
            }, function(ret){
                uiLoading.id = ret.id;
            });
             $api.apiAjax($api.detectUrl,$api.faceKey,{
                 image_file:ret.data
             },function(ret,err){
                 uiLoading.closeFlower ({id: uiLoading.id});
                 if(ret){
                     if(ret.faces.length == 0){
                         api.alert({
                             title: '提示',
                             msg: '未检测到人脸，请重新拍照',
                         }, function(ret, err){
                             if( ret ){
                                 detectFace()
                             }else{
                                 alert( JSON.stringify( err ) );
                             }
                         });
                     }else{
                         ocridcard();
                     }
                 }else{
                     alert(err.msg)
                 }
             })
        })
    }

    submitAuthInfo = function(ret){
        var card = ret.cards[0];
        api.confirm({
            title: '扫描结果',
            msg: card.name + ' ' +card.birthday + ' '+card.gender+' '+card.race+' '+card.address+ ' '+ card.id_card_number,
            buttons: ['确定', '取消']
        }, function(ret, err){
            if( ret ){
                 if(ret.buttonIndex == 1){
                     $api.ajax('PUT',$api.host + 'users/'+userinfo.user.id,{
                         auth_data: JSON.stringify(card)
                     },function(ret){
                         api.toast({
                             msg: '提交审核成功',
                             duration: 2000,
                             location: 'bottom'
                         });
                     },{
                         token:userinfo.token.token
                     })
                 }
            }else{
                 alert( JSON.stringify( err ) );
            }
        });


    }

    getPicture = function(fun){
        api.getPicture({
            sourceType: 'camera',
            encodingType: 'jpg',
            mediaValue: 'pic',
            destinationType: 'url',
            allowEdit: true,
            quality: 25,
            saveToPhotoAlbum: false
        }, function(ret, err){
            if(ret){
                fun(ret);
            }else{

            }
        })
    }
</script>

</html>
