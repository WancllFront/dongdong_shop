<!DOCTYPE html>
<html style="height:100%">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        body {background-color: #f4f4f4;height:100%}
        .other{margin-top: 0.7rem;}
        .other:after{display:block;content:"";clear:both;}
    </style>
</head>

<body>
    <header class="aui-bar aui-bar-nav aui-bar-light" id="header">
        <a class="aui-pull-left aui-btn" tapmode onclick="$api.closeWin()">
            <span class="aui-iconfont aui-icon-left" style="color:#000;"></span>
        </a>
        <div class="aui-title">登录</div>
    </header>

    <div class="area">
        <div class="mix">
            <i class="aui-iconfont aui-icon-mobile"></i>
            <input type="tel" class="input" id="telephone-novaricode" pattern="[0-9]*"  onkeyup="telephoneChange(value)" placeholder="输入手机号码">
        </div>

        <div class="mix">
            <i class="aui-iconfont aui-icon-lock"></i>
            <input type="password" class="input" id="password" placeholder="输入登录密码">
        </div>
        <div class="submit" tapmode onclick="login()">登录</div>
        <div class="other" style="width:100%;">
            <p style="float:left;color:#999" tapmode onclick="$api.goWindow('password_reset_win',{type:1})">忘记密码?</p>
            <p style="float:right;color:#999" tapmode onclick="$api.goWindow('reg_win')">没有账号?立即注册</p>
        </div>
    </div>

    <div class="third">第三方账号登录</div>
    <div class="icon">
        <!-- <img src="../image/sina.png" tapmode onclick="loginThird('weibo')"> -->
        <img src="../image/qq.png" tapmode onclick="loginThird('QQPlus')">
        <img src="../image/wechat.png" tapmode onclick="loginThird('wx')">
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/fastclick.js"></script>
<script type="text/javascript">
    window.addEventListener('load', function() {
      FastClick.attach(document.body);
    }, false);
    var uiLoading;
    var qq,wx,weibo
    apiready = function() {
        uiLoading = api.require("UILoading");
        qq = api.require("QQPlus");
        weibo = api.require("weibo");
        wx = api.require("wx");

        api.parseTapmode();
        api.setStatusBarStyle({ style: 'dark' });
        var header = $api.byId('header');
        $api.fixStatusBar(header);
        var headerH = $api.offset(header).h;
        var frameH = api.winHeight - headerH;
    };
    telephoneChange = function(value){
        value = value.replace(/[^\d]/g,'')
        value = value.substr(0,11)
        if(value.length >= 11){
            //$api.byId('telephone').blur();
            $api.byId('password').focus();
        }
        $api.val($api.byId('telephone-novaricode'), value);
    }
    login = function(){
        var telephone = $api.val($api.byId('telephone-novaricode'));
        var password = $api.val($api.byId('password'));

        if(!telephone || !password){
            api.toast({
                msg: '请填写完整的信息',
                duration: 2000,
                location: 'middle'
            });
            return;
        }

        $api.ajax('POST',$api.host + 'accounts/login',{
            guid: telephone,
            password: password,
            type: 1
        },function(ret){
            ret.data.user.avatar = ret.data.user.avatar || '../image/avatar.png';
            $api.setStorage('userinfo',ret.data);
            setTimeout(function(){
                $api.goWindow('home_win')
            },500)
        },{
            auth: $api.auth
        })
    }
    loginThird = function(type){
        // if(type == 'QQPlus'){
        //     qq.installed(function(ret, err) {
        //         if (ret.status) {
        //             qq.login(function(ret, err) {
        //                 api.alert({
        //                     title: 'id和token',
        //                     msg: ret.openId + ret.accessToken
        //                 });
        //             });
        //         } else {
        //             api.toast({ msg: "请安装qq客户端" });
        //         }
        //     });
        // }
        if(type == 'wx'){
            wx.auth({
                apiKey: 'wx5cd83565d0e1aea3'
            }, function(ret, err){
                if(ret.status){
                    console(JSON.stringify(ret));
                }else{
                    console(err.code);
                }
            });
        }
    }
</script>

</html>
