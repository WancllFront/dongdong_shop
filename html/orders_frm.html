<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        body {}
        .order{border-bottom: 0.5rem solid #f4f4f4;padding: 0rem 0.4rem;background-color: #fff;}
        .order .title{padding: 0.5rem 0rem;font-size: 0.75rem;}
        .order .title:after{display:block;content:"";clear:both;}
        .order .title .time{float: left;color: #999;}
        .order .title .status{float: right;color: #999;}

        .order .goodslist{background-color: #f4f4f4;display: flex;margin-bottom: 0.5rem;}
        .order .goodslist .thum{width: 20%;height: 100%;padding: 0.4rem 0.3rem;}
        .order .goodslist .thum img{max-width: 100%;vertical-align: middle;}
        .order .goodslist .text{width: 55%;padding-top: 0.5rem;padding-bottom: 0.5rem;}
        .order .goodslist .text .name{font-size: 0.75rem;color:#333;}
        .order .goodslist .other{padding-top: 0.5rem;width: 23%;padding-bottom: 0.5rem;}
        .order .goodslist .other .price{color:#df0303;text-align: right;}
        .order .goodslist .other .num{color:#555;text-align: right;}
        .order .goodslist .other .after{font-size: 0.75rem;height:1.5rem;line-height: 1.5rem;border-radius: 1.5rem;background-color: #fff;text-align: center;border: 1px solid #c3c3c3; max-width: 100%;width: 5rem;color:#555;display: inline-block;}

        .order .total-price{font-size: 0.75rem;text-align: right;color: #999;padding-bottom: 0.5rem;border-bottom: 1px solid #f4f4f4;}
        .order .button{text-align: right;margin-top: 0.5rem;padding-bottom: 0.5rem;}
        .order .button div{font-size: 0.75rem;height:1.5rem;line-height: 1.5rem;border-radius: 1.5rem;text-align: center;border: 1px solid #c3c3c3; color:#555;max-width: 26%;width:5rem;display: inline-block;}
        .order .button .blue{color:#358cff;border-color:#358cff}

    </style>
</head>

<body>
    <div style="background-color:#f4f4f4;height:0.5rem;width:100%;"></div>
    <section  class="aui-content" id="app">
        <div class="order" tapmode @click="goOrderDetail(order);" v-for="(order,key) in orders" :key="key">
            <div class="title">
                <span class="time">{{order.create_time}}</span>
                <span class="status" v-if="order.status == 1">待付款</span>
                <span class="status" v-else-if="order.status == 2">待发货</span>
                <span class="status" v-else-if="order.status == 3">待签收</span>
                <span class="status" v-else-if="order.status == 4">待评价</span>
                <span class="status" v-else-if="order.status == 5">已完成</span>
                <span class="status" v-else-if="order.status == 9">已取消</span>
            </div>
            <div class="goodslist" v-for="(goods,index) in order.goods_info" :key="index">
                <div class="thum">
                    <img :src="goods.thum">
                </div>
                <div class="text">
                    <div class="name">{{goods.name}}</div>
                </div>
                <div class="other">
                    <div class="price">￥{{goods.price}}</div>
                    <div class="num">x{{goods.num}}</div>
                    <!-- <div class="after">申请售后</div> -->
                </div>
            </div>
            <div class="total-price">共{{order.goods_info.length}}件商品&nbsp;合计:<span style="color:#df0303">￥{{order.total_money}}</span>&nbsp;(含运费:￥{{order.freight_money}})</div>
            <div class="button" v-if="order.shop_id == 0">
                <div v-if="order.status == 1" @click.stop="cancelOrder(order)">取消订单</div>
                <div class="blue" v-if="order.status == 1" @click.stop="pay(order)">立即付款</div>
                <div v-if="order.status == 2">提醒发货</div>
                <div class="blue" v-if="order.status==3" tapmode onclick="$api.goWindow('logistics_win')">查看物流</div>
                <div class="blue" v-if="order.status==3">确认收货</div>
                <div class="blue" v-if="order.status==4">评价</div>
            </div>
            <div class="button" v-if="order.shop_id != 0">
                <div v-if="order.delivery_way == 1">
                    <div v-if="order.status == 1"  @click.stop="cancelOrder(order)">取消订单</div>
                    <div class="blue" v-if="order.status == 1">付款</div>
                    <div v-if="order.status == 2">提醒发货</div>
                    <div v-if="order.status==3">配送中</div>
                    <div class="blue" v-if="order.status==3">确认收货</div>
                    <div class="blue" v-if="order.status==4">评价</div>
                </div>
                <div v-if="order.delivery_way == 2">
                    <div v-if="order.status == 1"  @click.stop="cancelOrder(order)">取消订单</div>
                    <div class="blue" v-if="order.status == 1"  >到店付款</div>
                    <div class="blue" v-if="order.status==4">评价</div>
                </div>
            </div>
        </div>

        <div class="shadow" id="shadow">
            <div class="shadow-modal" id="modal">
                <div class="title" >
                    <div tapmode onclick="cancelAward()" class="embed">
                        <img src="../image/cha.png" style="width:0.7rem;">
                    </div>
                    <p>请输入支付密码</p>
                    <div class="line"></div>
                </div>
                <div class="money">
                    <p class="label">金额</p>
                    <p class="coin" id="money"></p>
                    <div class="line"></div>
                </div>
                <div class="pwd">
                    <p class="label">密码</p>
                    <input type="password" id="password">
                    <div class="line"></div>
                </div>
                <div class="submit" id="submit" tapmode onclick="">
                    <p style="color:#fff;">确认支付</p>
                </div>
            </div>
        </div>
    </section>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/vue.min.js"></script>
<script type="text/javascript">
    var userinfo = $api.getStorage('userinfo');
    var app = new Vue({
        el: '#app',
        data:{
            orders:[],
            page:1
        },
        methods:{
            goOrderDetail: function(order){
                $api.goWindow('order_detail_win',{
                    order:order
                })
            },
            cancelOrder: function(order){
                api.confirm({
                    title: '提示',
                    msg: '确定取消订单吗',
                    buttons: ['确定', '取消']
                }, function(ret, err){
                    if( ret ){
                         if(ret.buttonIndex == 1){
                             $api.ajax('POST',$api.host + 'orders/cancel',{
                                 order_id:order.id
                             },function(ret){
                                 api.toast({
                                     msg: ret.msg,
                                     duration: 2000,
                                     location: 'middle'
                                 });
                                api.sendEvent({
                                    name: 'order_frm_refreshOrder',
                                });
                             },{
                                 token: userinfo.token.token
                             })
                         }
                    }else{
                         alert( JSON.stringify( err ) );
                    }
                });
            },
            pay: function(order){
                $api.css($api.byId('shadow'), 'opacity:1;z-index:9');
                $api.css($api.byId('modal'), 'opacity:1;');
                $api.text($api.byId('money'), order.total_money);
                $api.val($api.byId('password'),'')
            }
        }
    })
    apiready = function() {
        api.parseTapmode();

        setRefresh();
        addEventListener();
        loadOrders();
    };
    setRefresh = function(){
        api.setRefreshHeaderInfo({
            bgColor: '#f4f4f4',
            textColor: '#fff',
        }, function(ret, err){
            app.orders = [];
            app.page = 1;
            loadOrders();
        });
    }
    addEventListener = function(){
        api.addEventListener({
            name: 'scrolltobottom',
            extra:{
                threshold:20
            }
        }, function(ret, err){
            loadOrders()
        });

        api.addEventListener({
            name: 'order_frm_refreshOrder'
        }, function(ret, err){
            app.orders = [];
            app.page = 1;
            loadOrders();
        });

    }

    loadOrders = function(){
        $api.ajax('POST', $api.host + 'orders/lists', {
            status: api.pageParam.status
        },function(ret){
            if(ret.data.length != 0){
                app.page ++;
                ret.data.forEach(function(item){
                    app.orders.push(item);
                })
            }
        },{
            token: userinfo.token.token,
            'page-num':app.page,
            'page-limit':10
        })
    }

    cancelAward = function(){
        $api.css($api.byId('shadow'), 'opacity:0;z-index:-9');
        $api.css($api.byId('modal'), 'opacity:0;');
    }
</script>

</html>
